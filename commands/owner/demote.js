const moment = require(`moment`)

module.exports = {
    name: `demote`,
    FromOwner:true,
    async execute(message, args) {
        let id = args[0]
        let server = client.guilds.cache.get(config.idServer.idServer)
        let user = message.mentions.members.first() || server.members.cache.find(x => x.id == id) 
        if(!user) {
            let embed = new Discord.MessageEmbed()
                .setTitle(`Errore`)
                .setDescription(`*Non riesco a trovare l'utente\n\`!demote [utente]\`*`)
                .setColor(`RED`)
                .setThumbnail(config.images.roginotfound)
            message.reply({embeds: [embed]})
            return
        }
        if(!user.roles.cache.has(config.idruoli.helper) && !user.roles.cache.has(config.idruoli.moderator) && !user.roles.cache.has(config.idruoli.srmoderator) && !user.roles.cache.has(config.idruoli.owner)) {
            let embed = new Discord.MessageEmbed()
                .setTitle(`Errore`)
                .setDescription(`*Quest'utente non √® uno staffer*`)
                .setColor(`RED`)
                .setThumbnail(config.images.rogierror)
            message.reply({embeds: [embed]})
            return
        } else if(user.roles.cache.has(config.idruoli.srmoderator)) {
            user.roles.remove(config.idruoli.srmoderator)
            user.roles.add(config.idruoli.moderator)
            let dm = true
            let embedserver = new Discord.MessageEmbed()
                .setAuthor({name: `[DEMOTE] ${message.author.tag}`, iconURL: message.author.displayAvatarURL({dynamic: true})})
                .setDescription(`‚ö†Ô∏è**HO AVVISATO** QUEST'UTENTE IN DM‚ö†Ô∏è`)
                //.setThumbnail(config.images.rogi)
                .setColor(`PURPLE`)
                .addField(`Utente:`, `Nome: ${user.user.username}, ID: ${user.id}\n||${user.toString()}||`)
                .addField(`Grado:`, `<@&${config.idruoli.moderator}>`)
            let embedutente = new Discord.MessageEmbed()
                .setTitle(`Sei stato retrocesso!`)
                .setThumbnail(user.displayAvatarURL({dynamic: true, size: 512}))
                .setColor(`RED`)
                .addField(`Server:`, message.guild.name, true)
                .addField(`Grado:`, `Moderatore`, true)
            let embedlogs = new Discord.MessageEmbed()
                .setTitle(`üì§DEMOTEüì§`)
                .setDescription(`‚ö†Ô∏èL'utente **√® stato** avvisato nei dm‚ö†Ô∏è\n[Message link](https://discord.com/channels/${message.guild.id}/${message.channel.id}/${message.id})`)
                .addField(`‚è∞Orario:`, `${moment(new Date().getTime()).format(`ddd DD MMM YYYY, HH:mm:ss`)}`)
                .addField(`üî®Moderatore:`, `Nome: ${message.author.username}, ID: ${message.author.id}\n||${message.author.toString()}||`)
                .addField(`üë§Utente:`, `Nome: ${user.user.username}, ID: ${user.id}\n||${user.toString()}||`)
                .addField(`üìñGrado:`, `<@&${config.idruoli.moderator}>`)
                .setColor(`YELLOW`)
                .setThumbnail(user.displayAvatarURL({dynamic: true, size: 512}))
            await user.send({embeds: [embedutente]}).catch(() => { dm = false })
            if(dm == false) embedlogs.setDescription(`‚ö†Ô∏èL'utente **non √® stato** avvisato nei dm‚ö†Ô∏è\n[Message link](https://discord.com/channels/${message.guild.id}/${message.channel.id}/${message.id})`)
            if(dm == false) embedserver.setDescription(`‚ö†Ô∏è**NON POSSO AVVISARE** QUESTO UTENTE IN DM‚ö†Ô∏è`)
            message.reply({embeds: [embedserver]})
            client.channels.cache.get(config.idcanali.logs.other).send({embeds: [embedlogs]})
        } else if(user.roles.cache.has(config.idruoli.moderator)) {
            user.roles.remove(config.idruoli.moderator)
            user.roles.add(config.idruoli.helper)
            let dm = true
            let embedserver = new Discord.MessageEmbed()
                .setAuthor({name: `[DEMOTE] ${message.author.tag}`, iconURL: message.author.displayAvatarURL({dynamic: true})})
                .setDescription(`‚ö†Ô∏è**HO AVVISATO** QUEST'UTENTE IN DM‚ö†Ô∏è`)
                //.setThumbnail(config.images.rogi)
                .setColor(`PURPLE`)
                .addField(`Utente:`, `Nome: ${user.user.username}, ID: ${user.id}\n||${user.toString()}||`)
                .addField(`Grado:`, `<@&${config.idruoli.helper}>`)
            let embedutente = new Discord.MessageEmbed()
                .setTitle(`Sei stato retrocesso!`)
                .setThumbnail(user.displayAvatarURL({dynamic: true, size: 512}))
                .setColor(`RED`)
                .addField(`Server:`, message.guild.name, true)
                .addField(`Grado:`, `Helper`, true)
            let embedlogs = new Discord.MessageEmbed()
                .setTitle(`üì§DEMOTEüì§`)
                .setDescription(`‚ö†Ô∏èL'utente **√® stato** avvisato nei dm‚ö†Ô∏è\n[Message link](https://discord.com/channels/${message.guild.id}/${message.channel.id}/${message.id})`)
                .addField(`‚è∞Orario:`, `${moment(new Date().getTime()).format(`ddd DD MMM YYYY, HH:mm:ss`)}`)
                .addField(`üî®Moderatore:`, `Nome: ${message.author.username}, ID: ${message.author.id}\n||${message.author.toString()}||`)
                .addField(`üë§Utente:`, `Nome: ${user.user.username}, ID: ${user.id}\n||${user.toString()}||`)
                .addField(`üìñGrado:`, `<@&${config.idruoli.helper}>`)
                .setColor(`YELLOW`)
                .setThumbnail(user.displayAvatarURL({dynamic: true, size: 512}))
            await user.send({embeds: [embedutente]}).catch(() => { dm = false })
            if(dm == false) embedlogs.setDescription(`‚ö†Ô∏èL'utente **non √® stato** avvisato nei dm‚ö†Ô∏è\n[Message link](https://discord.com/channels/${message.guild.id}/${message.channel.id}/${message.id})`)
            if(dm == false) embedserver.setDescription(`‚ö†Ô∏è**NON POSSO AVVISARE** QUESTO UTENTE IN DM‚ö†Ô∏è`)
            message.reply({embeds: [embedserver]})
            client.channels.cache.get(config.idcanali.logs.other).send({embeds: [embedlogs]})
        } else if(user.roles.cache.has(config.idruoli.helper)) {
            user.roles.remove(config.idruoli.helper)
            user.roles.remove(config.idruoli.staff)
            let dm = true
            let embedserver = new Discord.MessageEmbed()
                .setAuthor({name: `[DEMOTE] ${message.author.tag}`, iconURL: message.author.displayAvatarURL({dynamic: true})})
                .setDescription(`‚ö†Ô∏è**HO AVVISATO** QUEST'UTENTE IN DM‚ö†Ô∏è`)
                //.setThumbnail(config.images.rogi)
                .setColor(`PURPLE`)
                .addField(`Utente:`, `Nome: ${user.user.username}, ID: ${user.id}\n||${user.toString()}||`)
                .addField(`Grado:`, `<@&${config.idruoli.fan}>`)
            let embedutente = new Discord.MessageEmbed()
                .setTitle(`Sei stato retrocesso!`)
                .setThumbnail(user.displayAvatarURL({dynamic: true, size: 512}))
                .setColor(`RED`)
                .addField(`Server:`, message.guild.name, true)
                .addField(`Grado:`, `Fan`, true)
            let embedlogs = new Discord.MessageEmbed()
                .setTitle(`üì§DEMOTEüì§`)
                .setDescription(`‚ö†Ô∏èL'utente **√® stato** avvisato nei dm‚ö†Ô∏è\n[Message link](https://discord.com/channels/${message.guild.id}/${message.channel.id}/${message.id})`)
                .addField(`‚è∞Orario:`, `${moment(new Date().getTime()).format(`ddd DD MMM YYYY, HH:mm:ss`)}`)
                .addField(`üî®Moderatore:`, `Nome: ${message.author.username}, ID: ${message.author.id}\n||${message.author.toString()}||`)
                .addField(`üë§Utente:`, `Nome: ${user.user.username}, ID: ${user.id}\n||${user.toString()}||`)
                .addField(`üìñGrado:`, `<@&${config.idruoli.fan}>`)
                .setColor(`YELLOW`)
                .setThumbnail(user.displayAvatarURL({dynamic: true, size: 512}))
            await user.send({embeds: [embedutente]}).catch(() => { dm = false })
            if(dm == false) embedlogs.setDescription(`‚ö†Ô∏èL'utente **non √® stato** avvisato nei dm‚ö†Ô∏è\n[Message link](https://discord.com/channels/${message.guild.id}/${message.channel.id}/${message.id})`)
            if(dm == false) embedserver.setDescription(`‚ö†Ô∏è**NON POSSO AVVISARE** QUESTO UTENTE IN DM‚ö†Ô∏è`)
            message.reply({embeds: [embedserver]})
            client.channels.cache.get(config.idcanali.logs.other).send({embeds: [embedlogs]})
        } else if(user.roles.cache.has(config.idruoli.owner)) {
            let embed = new Discord.MessageEmbed()
                .setTitle(`Errore`)
                .setDescription(`*Quest'utente non puo' essere retrocesso*`)
                .setColor(`RED`)
                .setThumbnail(config.images.rogierror)
            message.reply({embeds: [embed]})
        }
    }
}